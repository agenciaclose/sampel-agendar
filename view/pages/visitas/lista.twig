{% extends "layout/layoutMaster.twig" %}

{% block title %} Visitas {% endblock %}

{% block body %}

<div class="container py-5">
	
	<session>

		<div class="row mb-4">

			<div class="col-sm-12 col-md-7">
				<div><span>Lista de inscrições: <span class="text-warning fw-bold">{{ visita.title }}</span></span></div>
				<div class="d-flex justify-content-between">
					<span>
						Data da Visita: <span class="text-warning fw-bold">{{ visita.data_visita | date("d/m/Y") }} as {{ visita.horario_visita }}</span>
						<div>Fechamento das inscrições: <span class="text-warning fw-bold">{{ visita.data_close | date("d/m/Y") }}</span></div>
					</span>
					<span>Responsável: <div class="text-warning fw-bold">{{ visita.nome }}</div></span>
				</div>
				<div class="my-3">{{ visita.descricao|replace({'<p>': ' '})|replace({'<br>': ' '})|striptags }}</div>

				{% set agora = "now"|date("Y-m-d") %}
				{% set datavisita = visita.data_visita|date("Y-m-d") %}

				{% if agora >= datavisita %}
					<div class="d-flex align-items-end flex-wrap mt-2 mb-4 mb-sm-0">
						{% if sorteados %}
							<a href="{{ DOMAIN }}/visita/sorteados/{{ visita.visita_id }}" class="btn btn-light px-5 me-1 mt-1"><i class="fa-light fa-trophy-star"></i> Lista de Sorteados</a>
						{% else %}
							<button type="button" class="btn btn-warning px-5 mt-4 me-1 mt-1" data-bs-toggle="modal" data-bs-target="#sorteio"><i class="fa-light fa-trophy-star"></i> Realizar Sorteio</button>
						{% endif %}
						<div class="btn {{ _get.presenca == 'Sim' ? 'btn-warning' : 'btn-light' }} me-1 mt-1"><a class="text-black" href="{{ DOMAIN }}/visita/lista/{{ visita.visita_id }}?presenca=Sim"><i class="fa-solid fa-shield-check fa-lg {{ _get.presenca == 'Sim' ? 'text-dark' : 'text-warning' }}"></i> Confirmados</a></div>
						<div class="btn {{ _get.presenca == 'No' ? 'btn-warning' : 'btn-light' }} me-1 mt-1"><a class="text-black" href="{{ DOMAIN }}/visita/lista/{{ visita.visita_id }}?presenca=No"><i class="fa-solid fa-shield fa-lg text-dark"></i> Não confirmados</a></div>
					</div>
				{% endif %}
				
			</div>

			<div class="col-sm-12 col-md-5">
				<div><span class="text-warning">Estatísticas da Visita:</span></div>
				<div class="badge rounded-pill {{ _get.setor == '' ? 'bg-warning' : 'bg-light' }} mb-1 me-1">
					<a class="text-black" href="{{ DOMAIN }}/visita/lista/{{ visita.visita_id }}">Total <span class="px-1 bg-black rounded-pill text-white">{{ total.total }}</span></a>
				</div>
				{% for grupo in grupos %}
					<div class="badge rounded-pill {{ _get.setor == grupo.setor ? 'bg-warning' : 'bg-light' }} mb-1 me-1">
						<a class="text-black" href="{{ DOMAIN }}/visita/lista/{{ visita.visita_id }}?setor={{ grupo.setor }}">{{ grupo.setor }} <span class="px-1 bg-black rounded-pill text-white">{{ grupo.total }}</span></a>
					</div>
				{% endfor %}
				<div class="mt-3"><span class="text-warning">Gerenciamento de Equipe:</span></div>
				<div class="d-flex jus">
					<button type="button" data-bs-toggle="modal" data-bs-target="#verEquip" class="btn btn-warning btn-sm rounded-pill me-2">Equipe <span class="px-1 bg-black rounded-pill text-white">{{ equipevisita|length }}</span></button>
					{% if _session.sampel_user_gerente_equipe == 'S' %}
					<button type="button" data-bs-toggle="modal" data-bs-target="#editarEquip"  class="btn btn-warning btn-sm rounded-pill me-2"><i class="fa-solid fa-pen-to-square"></i> Editar Equipe</button>
					{% endif %}
					<a href="{{ DOMAIN }}/visita/inscricao/{{ visita.visita_id }}" class="btn btn-dark btn-sm rounded-pill"><i class="fa-solid fa-user-plus"></i> Nova inscrição</a>
				</div>
			</div>

		</div>

		<hr>

		<div class="table-responsive">
			<table id="tabela_dinamica" class="table table-hover align-middle text-white pt-4 mb-4 table-sm" style="width:100%">
		        <thead>
		            <tr>
						<th class="d-none">#</th>
						<th class="no-mobile">Nome</th>
						<th class="no-mobile">Empresa</th>
						<th class="no-mobile">Telefone</th>
						<th class="no-mobile">Setor</th>
						<th class="no-mobile">Endereço</th>
						<th class="no-mobile">Inscrição</th>
					</tr>
		        </thead>
		        <tbody>
		        	{% for lista in listas %}
						<tr>
							<td class="d-none">{{ lista.visita_id }}</td>
							<td class="ps-0 text-uppercase">
								<span class="d-flex justify-content-start text-nowrap" {{ lista.presenca == 'Sim' ? 'data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="PRESENÇA CONFIRMADA"' : 'data-bs-toggle="tooltip" data-bs-placement="top"  data-bs-title="PRESENÇA AINDA NÃO CONFIRMADA"' }}>
									
									<div>{{ lista.presenca == 'Sim' ? '<i class="fa-solid fa-shield-check fa-lg text-warning"></i>' : '<i class="fa-solid fa-shield fa-lg text-dark"></i>' }}</div>
									<div class="ms-2 row">
										<div class="col-md-6 col-sm-12">
											{{ lista.nome }}
											<div class="text-lowercase">{{ lista.email }}</div>
											{% if lista.cidade != '' %}<div>{{ lista.cidade }}, {{ lista.estado }}</div>{% endif %}
											<div>{{ lista.empresa }}</div>
										</div>
										<div class="col-md-6 col-sm-12">
											<a href="{{ DOMAIN }}/palestras/etiqueta/{{ lista.codigo }}" target="_blank" class="badge bg-warning text-black mt-2"><i class="fa-regular fa-arrow-up-right-from-square"></i> VER INSCRIÇÃO</a>
										</div>
									</div>
								</span>
							</td>
							<td class="ps-0 no-mobile text-uppercase">{{ lista.empresa }}</td>
							<td class="ps-0 no-mobile text-uppercase text-nowrap">{{ lista.telefone }}</td>
							<td class="ps-0 no-mobile">{{ lista.setor }}</td>
							<td class="ps-0 text-nowrap no-mobile">{{ lista.cidade }}, {{ lista.estado }}</td>
							<td class="no-mobile">
								<a href="{{ DOMAIN }}/etiqueta/{{ lista.codigo }}" target="_blank" class="badge bg-warning text-black"><i class="fa-regular fa-arrow-up-right-from-square"></i> VER INSCRIÇÃO</a>
								<div>{{ lista.data|date("d/m/Y H:i") }}</div>
							</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
		</div>

	</session>

</div>

{% if agora >= datavisita %}
<div class="modal fade" id="sorteio" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-sm" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<span class="modal-title text-black">Digite a Quantidade de Sorteados</span>
			</div>
			<div class="modal-body">
				<form id="sorteioForm">
					<div class="form-group mt-2 mb-4">
						<input type="number" name="quantidade" class="form-control form-control-lg text-center" min="1" value="1" id="quantidade" required>
						<input type="hidden" name="id_visita" id="id_visita" value="{{ visita.visita_id }}">
					</div>
					<div id="timer" class="text-black my-4 text-center"></div>
					<button type="submit" class="btn btn-warning btn-lg w-100">REALIZAR SORTEIO</button>
				</form>
			</div>
		</div>
	</div>
</div>
<script src="{{ PATH }}/view/src/js/services/sorteio.js"></script>
{% endif %}

<div class="modal fade" id="verEquip" tabindex="-1" role="dialog" aria-labelledby="verEquipLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-body">
				<div><label class="text-black"><b>Lista de membros da equipe dessa Visita</b></label></div>
				<table class="table table-striped table-sm">
					<tbody>
						{% if equipevisita|length == 0 %}
							<tr>
								<td class="text-uppercase">Nenhuma equipe até o momento.</td>
							</tr>
						{% endif %}
						{% for equipe in equipevisita %}
						<tr>
							<td class="text-uppercase" style="line-height:normal">
								{{ equipe.nome }}
								<div><small>{{ equipe.data_equipe | date("d/m/Y H:i") }}</small></div>
							</td>
							<td class="text-end">{{ equipe.setor }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>

				{% if _session.sampel_user_gerente_equipe == 'S' %}
					{% if equipevisita|length > 0 %}
						<hr>
						{% if visita.email_equipe == 'N' %}
						<button type="button" data-visita="{{ visita.visita_id }}" class="send_email_equipe btn btn-warning btn-lg w-100"><i class="fa-solid fa-paper-plane"></i> ENVIAR EMAIL PARA TODOS</button>
						{% else %}
						<button type="button" class="btn btn-secondary btn-lg w-100"><i class="fa-solid fa-shield-check"></i> EMAIL DE EQUIPE ENVIADO</button>
						{% endif %}
					{% endif %}
				{% endif %}

			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="editarEquip" tabindex="-1" role="dialog" aria-labelledby="editarEquipLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-body">
				<div class="form-load"><i class="fa-solid fa-spinner fa-spin-pulse"></i></div>
				<form action="javascript:void(0);" method="POST" id="form_editar_equipe">
					<div class="mb-2">
						<div><label class="text-black"><b>Selecione os membros da equipe</b></label></div>
						<select class="form-control select2-tag" name="editar_equipe[]" multiple="multiple">
							{% for todasequipe in todasequipes %}
								<option value="{{ todasequipe.id }}" {{ (todasequipe.id in equipeselecionada) ? 'selected' : '' }}>{{ todasequipe.nome }}</option>
							{% endfor %}
						</select>
					</div>
					<div>
						<input type="hidden" name="id_visita" value="{{ visita.visita_id }}">
						<button type="submit" class="btn btn-warning">SALVAR MEMBROS DA EQUIPE</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script src="{{ PATH }}/view/src/js/services/visitas.js"></script>

{% endblock %}